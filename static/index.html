<!DOCTYPE html>
<html lang="zh-Hant" data-theme="night">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clip + Learned Image Compression Demo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet" />
  <style>
    #previewDWrapper, #previewCWrapper { min-height: 240px; }
    .fade-in { animation: fade 200ms ease-out; }
    @keyframes fade { from {opacity:0} to {opacity:1} }
    .dropzone { cursor: pointer; }
  
/* === Day / Night variables === */
:root{
  --bg1:#eef3ff; --bg2:#fff1f7;
  --glass-bg: rgba(255,255,255,.55);
  --glass-border: rgba(255,255,255,.35);
  --glass-shadow: 0 24px 64px rgba(0,0,0,.18);
}
html[data-theme="night"]{
  --bg1:#0b1220; --bg2:#1c2540;
  --glass-bg: rgba(16,20,28,.55);
  --glass-border: rgba(255,255,255,.12);
  --glass-shadow: 0 36px 96px rgba(0,0,0,.55);
}
@media (prefers-color-scheme: dark){
  html:not([data-theme]) :root{
    --bg1:#0b1220; --bg2:#1c2540;
    --glass-bg: rgba(16,20,28,.55);
    --glass-border: rgba(255,255,255,.12);
    --glass-shadow: 0 36px 96px rgba(0,0,0,.55);
  }
}
/* Page background layers */
body::before{
  content:""; position:fixed; inset:0; z-index:-2;
  background:
    radial-gradient(1200px 800px at 10% -10%, var(--bg2) 0%, transparent 55%),
    radial-gradient(1000px 700px at 110% 10%, var(--bg1) 0%, transparent 55%),
    linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 100%);
}
body::after{
  content:""; position:fixed; inset:0; z-index:-1;
  backdrop-filter: blur(6px) saturate(110%);
  -webkit-backdrop-filter: blur(6px) saturate(110%);
  background: transparent; pointer-events:none;
}
/* Thick glass card */
.glass-thick{
  position:relative;
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  box-shadow: var(--glass-shadow);
  backdrop-filter: blur(20px) saturate(160%);
  -webkit-backdrop-filter: blur(20px) saturate(160%);
  border-radius: 1rem;
}
.glass-thick::before{
  content:""; position:absolute; inset:0; border-radius: inherit; pointer-events:none;
  background: linear-gradient(to bottom right, rgba(255,255,255,.35), rgba(255,255,255,0) 60%);
  mix-blend-mode: overlay;
  box-shadow: inset 0 1px rgba(255,255,255,.25);
}

  
/* === Mouse-follow glow =============================================== */
:root{
  --mx: 50vw;           /* cursor x (fallback center) */
  --my: 50vh;           /* cursor y (fallback center) */
  --glow-inner: rgba(255,255,255,0.22);
  --glow-mid:   rgba(255,255,255,0.08);
}
html[data-theme="night"]{
  --glow-inner: rgba(160,200,255,0.25);
  --glow-mid:   rgba(160,200,255,0.06);
}
#cursor-glow{
  position: fixed; inset: 0;
  z-index: 0;                /* above body::after (-1), below most content (auto/0 is fine) */
  pointer-events: none;
  mix-blend-mode: screen;    /* softly lightens underlying colors */
  background:
    radial-gradient(240px 240px at var(--mx) var(--my),
      var(--glow-inner) 0%,
      var(--glow-mid) 25%,
      transparent 55%);
  transition: background-position .08s linear;
}
@media (prefers-reduced-motion: reduce){
  #cursor-glow{ display:none; }
}


/* --- Masonry-like grid using CSS columns --- */
.masonry{ column-gap: 1rem; }
.masonry-item{ break-inside: avoid; margin-bottom: 1rem; }

</style>
</head>
<body class="min-h-screen bg-base-100 text-base-content">
  <div id="cursor-glow" aria-hidden="true"></div>

  <div class="navbar glass-thick sticky top-0 z-10">
    <div class="flex-1 px-2 text-lg font-semibold">Searchable Generative Image Compression</div>
    <div class="flex-none">
      <label class="swap swap-rotate mx-2 cursor-pointer" title="切換主題">
        <input id="themeToggle" type="checkbox" />
        <svg class="swap-on fill-current w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M21.64 13a1 1 0 0 0-1.05-.14 8 8 0 0 1-10.45-10.45A1 1 0 0 0 9 1.36 10 10 0 1 0 22 14a1 1 0 0 0-.36-1z"/>
        </svg>
        <svg class="swap-off fill-current w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path d="M5 12a7 7 0 1 0 14 0A7 7 0 0 0 5 12zm7-9a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V4a1 1 0 0 1 1-1zm0 16a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0v-1a1 1 0 0 1 1-1zM4 11H3a1 1 0 0 0 0 2h1a1 1 0 1 0 0-2zm17 0h-1a1 1 0 1 0 0 2h1a1 1 0 1 0 0-2zM6.22 5.64a1 1 0 0 1 1.41 0l.71.7a1 1 0 1 1-1.41 1.42l-.71-.71a1 1 0 0 1 0-1.41zm9.44 9.44a1 1 0 0 1 1.41 0l.71.71a1 1 0 1 1-1.41 1.41l-.71-.7a1 1 0 0 1 0-1.42zM6.22 18.36a1 1 0 0 1 0-1.41l.71-.71a1 1 0 1 1 1.41 1.41l-.71.71a1 1 0 0 1-1.41 0zm9.44-9.44a1 1 0 0 1 0-1.41l.71-.71a1 1 0 1 1 1.41 1.41l-.71.71a1 1 0 0 1-1.41 0z"/>
        </svg>
      </label>
    </div>
  </div>
  <main class="max-w-6xl mx-auto px-4 py-8">
    <section class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <article class="card glass-thick hover:shadow-2xl transition">
        <div class="card-body space-y-5">
          <header class="flex items-center gap-3">
            <div class="btn btn-circle btn-primary btn-lg pointer-events-none">⤓</div>
            <div>
              <h3 class="card-title">Compress → 產出 .c2df</h3>
              <p class="text-sm opacity-70">選擇影像並上傳，底下會先顯示該影像；壓縮完成後可手動下載 bitstream</p>
            </div>
          </header>
          <div id="dzCompress" class="dropzone rounded-2xl p-6 text-center border border-base-content/20 hover:bg-primary/10 transition">
            <p class="font-medium">拖放影像到此或點擊選擇</p>
            <p class="text-sm opacity-60">支援：.png / .jpg / .jpeg / .webp / .bmp</p>
            <input id="fileCompress" type="file" accept="image/*" class="hidden" />
          </div>
          <div class="flex items-center gap-3">
            <button id="btnCompress" class="btn btn-primary"><span class="loading loading-spinner hidden" id="spinC"></span>開始壓縮</button>
            <button id="btnClearC" class="btn btn-ghost">清除</button>
            <a id="btnDownloadC" class="btn btn-outline btn-disabled" aria-disabled="true" tabindex="-1">下載 bitstream</a>
          </div>
          <div id="progC" class="hidden">
            <progress id="barC" class="progress progress-info w-full" value="0" max="100"></progress>
            <div class="mt-1 text-right text-sm" id="txtC">0%</div>
          </div>
          <div id="previewCWrapper" class="hidden space-y-3">
            <div class="text-sm opacity-70">上傳影像預覽</div>
            <div id="previewC" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
          </div>
          <div id="resultC" class="hidden"></div>
        </div>
      </article>
      <article class="card glass-thick hover:shadow-2xl transition">
        <div class="card-body space-y-5">
          <header class="flex items-center gap-3">
            <div class="btn btn-circle btn-secondary btn-lg pointer-events-none">↯</div>
            <div>
              <h3 class="card-title">Decompress → 還原 PNG</h3>
              <p class="text-sm opacity-70">選擇 <code>.c2df</code> 檔，上方會先顯示解碼預覽；一定要手動按「下載結果」才會下載</p>
            </div>
          </header>
          <div id="dzDecompress" class="dropzone rounded-2xl p-6 text-center border border-base-content/20 hover:bg-secondary/10 transition">
            <p class="font-medium">拖放 <code>.c2df</code> 到此或點擊選擇</p>
            <p class="text-sm opacity-60">只接受：.c2df</p>
            <input id="fileDecompress" type="file" accept=".c2df" class="hidden" />
          </div>
          <div class="flex items-center gap-3">
            <button id="btnDecompress" class="btn btn-secondary"><span class="loading loading-spinner hidden" id="spinD"></span>開始還原</button>
            <button id="btnClearD" class="btn btn-ghost">清除</button>
            <a id="btnDownloadD" class="btn btn-primary btn-disabled" aria-disabled="true" tabindex="-1">下載結果</a>
          </div>
          <div id="progD" class="hidden">
            <progress id="barD" class="progress progress-success w-full" value="0" max="100"></progress>
            <div class="mt-1 text-right text-sm" id="txtD">0%</div>
          </div>
          <div id="previewDWrapper" class="hidden space-y-3">
            <div class="text-sm opacity-70">還原預覽</div>
            <div id="previewD" class="grid grid-cols-2 sm:grid-cols-3 gap-3"></div>
          </div>
          <div id="resultD" class="hidden"></div>
        </div>
      </article>
    </section>
    <aside class="mt-8 grid md:grid-cols-2 gap-4">
      <div class="card glass-thick">
        <div class="card-body p-6">
          <h3 class="card-title">提示</h3>
          <ul class="list-disc pl-5 opacity-80 space-y-1 text-sm">
            <li>壓縮回傳 <code>.c2df</code>；還原若為多張圖，會以 ZIP 回傳。</li>
            <li>還原：先預覽，再按「下載結果」。ZIP 會預覽前幾張縮圖。</li>
          </ul>
        </div>
      </div>
      <div class="card glass-thick">
        <div class="card-body p-6">
          <h3 class="card-title">系統狀態</h3>
          <div id="status" class="text-sm opacity-80">待命中…</div>
        </div>
      </div>
    </aside>
  
<section id="searchSection" class="mt-10 space-y-6">
  <article class="card glass-thick">
    <div class="card-body space-y-4">
      <header class="flex items-center gap-3">
        <div class="btn btn-circle btn-accent btn-lg pointer-events-none">🔎</div>
        <div>
          <h3 class="card-title">語意檢索：以文 / 以圖 / 以 .c2df 搜圖</h3>
          <p class="text-sm opacity-70">查詢會以 Google 圖片搜尋的方式呈現結果（瀑布流、懸浮顯示檔名與分數）。</p>
        </div>
      </header>
      <div class="grid md:grid-cols-3 gap-4">
        <div class="md:col-span-2 space-y-3">
          <div class="form-control">
            <label class="label"><span class="label-text">以文字查圖</span></label>
            <div class="join w-full">
              <input id="txtQuery" type="text" class="input input-bordered join-item w-full" placeholder="例如：a red vintage car" />
              <button id="btnSearchText" class="btn btn-accent join-item">搜尋</button>
            </div>
          </div>
          <div class="form-control">
            <label class="label"><span class="label-text">以圖 / .c2df 查圖（拖放或點擊選擇）</span></label>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div id="dzSearchImg" class="dropzone rounded-2xl p-5 text-center border border-base-content/20 hover:bg-accent/10 transition">
                <p class="font-medium">圖片搜圖</p>
                <p class="text-xs opacity-60">.png .jpg .jpeg .webp .bmp</p>
                <input id="fileSearchImg" type="file" accept="image/*" class="hidden" />
              </div>
              <div id="dzSearchC2" class="dropzone rounded-2xl p-5 text-center border border-base-content/20 hover:bg-accent/10 transition">
                <p class="font-medium">.c2df 搜圖</p>
                <p class="text-xs opacity-60">只接受：.c2df</p>
                <input id="fileSearchC2" type="file" accept=".c2df" class="hidden" />
              </div>
            </div>
            <div class="flex gap-2 mt-2">
              <button id="btnSearchImage" class="btn btn-outline">以圖搜尋</button>
              <button id="btnSearchC2DF" class="btn btn-outline">以 .c2df 搜尋</button>
            </div>
          </div>
        </div>
        <div class="space-y-3">
          <label class="label"><span class="label-text">Top-K</span></label>
          <input id="rangeTopK" type="range" min="1" max="50" value="12" class="range range-accent">
          <div class="w-full flex justify-between text-xs px-1 opacity-70">
            <span>1</span><span id="topkVal">12</span><span>50</span>
          </div>
          
        </div>
      </div>
    </div>
  </article>
  <article class="card glass-thick">
    <div class="card-body">
      <header class="flex items-center gap-3 mb-2">
        <h3 class="card-title">搜尋結果</h3>
        <span id="searchStatus" class="text-sm opacity-70"></span>
      </header>
      <div id="gridResults" class="masonry columns-1 sm:columns-2 md:columns-3 lg:columns-4 xl:columns-5"></div>
    </div>
  </article>
</section>

</main>
  <script>
  (function initTheme(){
    const saved = localStorage.getItem('theme');
    const theme = saved || 'night';
    document.documentElement.setAttribute('data-theme', theme);
    document.getElementById('themeToggle').checked = (theme === 'cupcake');
  })();
  document.getElementById('themeToggle').addEventListener('change', (e) => {
    const next = e.target.checked ? 'cupcake' : 'night';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
  });
  const ENDPOINTS = { compress: '/compress', decompress: '/decompress' };
  const $ = (sel) => document.querySelector(sel);
  const prettyBytes = (n) => { if(n==null) return ''; const u=['B','KB','MB','GB']; const i=Math.floor(Math.log(n)/Math.log(1024)); return `${(n/1024**i).toFixed(1)} ${u[i]}`; };
  const filenameFromCD = (xhr) => {
    const cd = xhr.getResponseHeader('Content-Disposition') || '';
    const s1 = /filename\\*=UTF-8''([^;]+)/i.exec(cd);
    if (s1) return decodeURIComponent(s1[1]);
    const s2 = /filename="?([^\\\";]+)"?/i.exec(cd);
    return s2 ? s2[1] : 'download';
  };
  function bindDrop(boxSel, inputSel, exts) {
    const box=$(boxSel), input=$(inputSel);
    const openPicker=()=>input.click();
    box.addEventListener('click', openPicker);
    box.addEventListener('dragover', e=>{ e.preventDefault(); box.classList.add('dragover'); });
    box.addEventListener('dragleave', ()=> box.classList.remove('dragover'));
    box.addEventListener('drop', e=>{
      e.preventDefault(); box.classList.remove('dragover');
      const f=e.dataTransfer.files?.[0]; if(!f) return;
      if (exts && !exts.some(ext => f.name.toLowerCase().endsWith(ext))) { alert('不支援的檔案類型'); return; }
      input.files = e.dataTransfer.files;
      box.querySelector('p').innerHTML = `<span class="text-primary">已選擇：</span> ${f.name} <span class="opacity-60 text-xs">(${prettyBytes(f.size)})</span>`;
      if (input.id === 'fileCompress') showCompressPreview(f);
    });
    input.addEventListener('change', ()=>{
      const f=input.files?.[0]; if(!f) return;
      if (exts && !exts.some(ext => f.name.toLowerCase().endsWith(ext))) { alert('不支援的檔案類型'); input.value=''; return; }
      box.querySelector('p').innerHTML = `<span class="text-primary">已選擇：</span> ${f.name} <span class="opacity-60 text-xs">(${prettyBytes(f.size)})</span>`;
      if (input.id === 'fileCompress') showCompressPreview(f);
    });
  }
  bindDrop('#dzCompress', '#fileCompress', ['.png','.jpg','.jpeg','.webp','.bmp']);
  bindDrop('#dzDecompress', '#fileDecompress', ['.c2df']);
  bindDrop('#dzSearchImg', '#fileSearchImg', ['.png','.jpg','.jpeg','.webp','.bmp']);
  bindDrop('#dzSearchC2',  '#fileSearchC2',  ['.c2df']);
  function setDownloadDisabled(a, disabled) {
    if (disabled) {
      a.classList.add('btn-disabled');
      a.setAttribute('aria-disabled', 'true');
      a.setAttribute('tabindex', '-1');
      a.removeAttribute('href');
      a.removeAttribute('download');
    } else {
      a.classList.remove('btn-disabled');
      a.removeAttribute('aria-disabled');
      a.removeAttribute('tabindex');
    }
  }
  function showCompressPreview(file){
    const wrap = $('#previewCWrapper');
    const grid = $('#previewC');
    grid.innerHTML = '';
    const url = URL.createObjectURL(file);
    const img = new Image(); img.src=url; img.alt='上傳影像'; img.className='rounded-xl shadow bg-base-300 object-cover w-full aspect-square fade-in';
    grid.appendChild(img);
    wrap.classList.remove('hidden');
    img.onload = ()=> setTimeout(()=>URL.revokeObjectURL(url), 3000);
  }
  async function postFile(kind) {
    const isC = kind==='compress';
    const inp = isC? $('#fileCompress') : $('#fileDecompress');
    const prog= isC? $('#progC')        : $('#progD');
    const bar = isC? $('#barC')         : $('#barD');
    const txt = isC? $('#txtC')         : $('#txtD');
    const panel = isC? $('#resultC')    : $('#resultD');
    if (!inp.files?.length) { alert('請先選擇檔案'); return; }
    panel.classList.add('hidden');
    setDownloadDisabled(isC ? $('#btnDownloadC') : $('#btnDownloadD'), true);
    const data = new FormData(); data.append('file', inp.files[0]);
    const xhr = new XMLHttpRequest();
    xhr.open('POST', ENDPOINTS[kind]);
    xhr.responseType = 'blob';
    xhr.upload.onprogress = (e)=> {
      if (e.lengthComputable) {
        const p = Math.round(e.loaded/e.total*100);
        prog.classList.remove('hidden');
        bar.value = p; txt.textContent = `${p}% · ${prettyBytes(e.loaded)} / ${prettyBytes(e.total)}`;
      }
    };
    xhr.onload = async () => {
      prog.classList.add('hidden');
      if (xhr.status !== 200) {
        const fr = new FileReader();
        fr.onload = ()=> { try { const j=JSON.parse(fr.result); alert(`錯誤：${j.detail||xhr.statusText}`); } catch { alert(`伺服器錯誤：HTTP ${xhr.status}`); } };
        fr.readAsText(xhr.response); return;
      }
      const blob = xhr.response;
      const ctype = xhr.getResponseHeader('Content-Type') || 'application/octet-stream';
      const name  = filenameFromCD(xhr) || (isC? 'output.c2df':'output');
      const url   = URL.createObjectURL(blob);
      if (isC) {
        const a = $('#btnDownloadC');
        a.href = url;
        a.download = name.endsWith('.c2df') ? name : (name + '.c2df');
        setDownloadDisabled(a, false);
        a.addEventListener('click', ()=> setTimeout(()=>URL.revokeObjectURL(url), 3000), { once: true });
        $('#status').textContent = `壓縮完成，請手動下載：${a.download}`;
        panel.classList.remove('hidden');
        panel.innerHTML = `<div class="alert alert-success">壓縮完成！<span class="ml-2 text-xs opacity-80">${a.download}</span></div>`;
      } else {
        const wrap = $('#previewDWrapper');
        const grid = $('#previewD');
        grid.innerHTML='';
        wrap.classList.remove('hidden');
        const a = $('#btnDownloadD');
        if (ctype.startsWith('image/')) {
          const img = new Image(); img.src=url; img.alt='還原預覽'; img.className='rounded-xl shadow bg-base-300 object-contain w-full aspect-square fade-in';
          grid.appendChild(img);
          a.href = url;
          a.download = name.endsWith('.png') ? name : (name + '.png');
          setDownloadDisabled(a, false);
          a.addEventListener('click', ()=> setTimeout(()=>URL.revokeObjectURL(url), 3000), { once: true });
          $('#status').textContent = '還原完成：預覽就緒（請手動下載）';
        } else if (ctype.includes('zip')) {
          try {
            const { default: JSZip } = await import('https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js');
            const arr = await blob.arrayBuffer();
            const zip = await JSZip.loadAsync(arr);
            const entries = Object.keys(zip.files).filter(k=>/\\.(png|jpe?g|webp|bmp)$/i.test(k));
            for (let i=0;i<Math.min(entries.length,6);i++){
              const file = await zip.files[entries[i]].async('blob');
              const u = URL.createObjectURL(file);
              const img = new Image(); img.src=u; img.className='rounded-xl shadow object-cover w-full aspect-square fade-in'; img.loading='lazy';
              grid.appendChild(img);
            }
            a.href = url;
            a.download = name.endsWith('.zip') ? name : (name + '.zip');
            setDownloadDisabled(a, false);
            a.addEventListener('click', ()=> setTimeout(()=>URL.revokeObjectURL(url), 3000), { once: true });
            $('#status').textContent = `還原完成：ZIP（共 ${entries.length} 張，已預覽 ${Math.min(entries.length,6)} 張）`;
          } catch (e) {
            grid.innerHTML = '<div class="alert alert-warning">ZIP 無法預覽，但仍可下載。</div>';
            a.href = url;
            a.download = name.endsWith('.zip') ? name : (name + '.zip');
            setDownloadDisabled(a, false);
            a.addEventListener('click', ()=> setTimeout(()=>URL.revokeObjectURL(url), 3000), { once: true });
          }
        } else {
          grid.innerHTML = '<div class="alert alert-warning">未知的回應格式，無法預覽，但仍可下載。</div>';
          a.href = url;
          a.download = name;
          setDownloadDisabled(a, false);
          a.addEventListener('click', ()=> setTimeout(()=>URL.revokeObjectURL(url), 3000), { once: true });
        }
        panel.classList.remove('hidden');
        panel.innerHTML = `<div class="alert alert-success">還原完成！<span class="ml-2 text-xs opacity-80">${a.download}</span></div>`;
      }
    };
    xhr.onerror = ()=> { prog.classList.add('hidden'); alert('網路錯誤或伺服器無回應'); };
    xhr.send(data);
    $('#status').textContent = isC? '壓縮中…' : '還原中…';
  }
  document.getElementById('btnCompress').addEventListener('click', ()=> postFile('compress'));
  document.getElementById('btnDecompress').addEventListener('click', ()=> postFile('decompress'));
  document.getElementById('btnClearC').addEventListener('click', ()=>{
    $('#fileCompress').value=''; $('#dzCompress p').innerHTML='拖放影像到此或點擊選擇';
    $('#resultC').classList.add('hidden'); $('#previewCWrapper').classList.add('hidden'); $('#previewC').innerHTML='';
    setDownloadDisabled($('#btnDownloadC'), true);
  });
  document.getElementById('btnClearD').addEventListener('click', ()=>{
    $('#fileDecompress').value=''; $('#dzDecompress p').innerHTML='拖放 <code>.c2df</code> 到此或點擊選擇';
    $('#resultD').classList.add('hidden'); $('#previewDWrapper').classList.add('hidden'); $('#previewD').innerHTML='';
    setDownloadDisabled($('#btnDownloadD'), true);
  });
  document.getElementById('btnDownloadD').addEventListener('click', (e) => {
    if (e.currentTarget.getAttribute('aria-disabled') === 'true') e.preventDefault();
  });
  document.getElementById('btnDownloadC').addEventListener('click', (e) => {
    if (e.currentTarget.getAttribute('aria-disabled') === 'true') e.preventDefault();
  });
  </script>

<script>
(function(){
  const root = document.documentElement;
  let tx = innerWidth * 0.5, ty = innerHeight * 0.5; // target
  let x = tx, y = ty;                                // current (smoothed)
  let raf = null;

  function lerp(a,b,t){ return a + (b-a)*t; }

  function loop(){
    x = lerp(x, tx, 0.18);
    y = lerp(y, ty, 0.18);
    root.style.setProperty('--mx', x + 'px');
    root.style.setProperty('--my', y + 'px');
    raf = requestAnimationFrame(loop);
  }

  window.addEventListener('pointermove', (e)=>{
    tx = e.clientX; ty = e.clientY;
    if (raf==null) raf = requestAnimationFrame(loop);
  }, { passive: true });

  // Recenter on resize
  window.addEventListener('resize', ()=>{
    tx = innerWidth * 0.5; ty = innerHeight * 0.5;
  });

  // Start with center glow so there's a subtle light even before moving
  root.style.setProperty('--mx', tx + 'px');
  root.style.setProperty('--my', ty + 'px');
  raf = requestAnimationFrame(loop);
})();
</script>

<script>
ENDPOINTS.search_text = '/search/text';
ENDPOINTS.search_image = '/search/image';
ENDPOINTS.search_c2df  = '/search/c2df';

ENDPOINTS.search_text_stream  = '/search/stream/text';
ENDPOINTS.search_image_stream = '/search/stream/image';
ENDPOINTS.search_c2df_stream  = '/search/stream/c2df';

window.fmtMs = window.fmtMs || function(ms){ const n=Number(ms); if(!Number.isFinite(n))return''; if(Math.abs(n)<1000)return `${Math.round(n)} ms`; const s=n/1000; return `${s.toFixed(s>=10?1:2)} s`; };
window.prettyBytes = window.prettyBytes || function(bytes){ const num=Number(bytes); if(!Number.isFinite(num))return''; const neg=num<0; let n=Math.abs(num); if(n<1024)return(neg?-n:n)+' B'; const u=['KB','MB','GB','TB','PB','EB','ZB','YB']; let i=-1; do{ n/=1024; ++i; }while(n>=1024 && i<u.length-1); return (neg?'-':'') + (n>=10?n.toFixed(0):n.toFixed(1)) + ' ' + u[i]; };

const $s = (sel)=> document.querySelector(sel);
const getVal = (sel)=> { const el = $s(sel); return el ? String(el.value).trim() : ""; };
const topkRange = $s('#rangeTopK'); const topkVal = $s('#topkVal');
topkRange.addEventListener('input', ()=> topkVal.textContent = topkRange.value);

function setSearchStatus(s){ $s('#searchStatus').textContent = s; }
function clearResults(){ $s('#gridResults').innerHTML=''; }
function fmtScore(x){ if (x==null) return ''; const s=Number(x); return isFinite(s) ? s.toFixed(3) : ''; }

function appendResultItem(it){
  if (!it || !it.preview_url) return;
  const grid = $s('#gridResults');
  const a = document.createElement('a');
  a.href = it.preview_url || '#'; a.target = '_blank'; a.rel='noreferrer noopener';
  a.className = 'masonry-item block group relative rounded-xl overflow-hidden shadow';
  const img = new Image(); img.src = it.preview_url || ''; img.alt = it.path || ''; img.loading='lazy';
  img.className='w-full h-auto object-cover transition-transform duration-200 group-hover:scale-[1.02]';
  const overlay = document.createElement('div');
  overlay.className='pointer-events-none absolute inset-0 bg-gradient-to-t from-black/60 via-black/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity';
  const label = document.createElement('div');
  label.className='absolute bottom-0 left-0 right-0 p-2 text-[11px] text-white/90';
  label.innerHTML = `<div class="flex items-center justify-between gap-2">
    <span class="truncate">${(it.path||'').split(/[\\/]/).pop()}</span>
    <span class="badge badge-sm badge-neutral">score ${fmtScore(it.score)}</span>
  </div>`;
  a.appendChild(img); a.appendChild(overlay); a.appendChild(label);
  grid.appendChild(a);
}

async function streamNDJSON(url, fetchOpts, onLine){
  const res = await fetch(url, fetchOpts);
  if (!res.ok) throw new Error(await res.text());
  if (!res.body) throw new Error('此瀏覽器不支援串流 Response.body');
  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  let buf = '';
  while(true){
    const {done, value} = await reader.read();
    if (done) break;
    buf += decoder.decode(value, {stream:true});
    let idx;
    while((idx = buf.indexOf('\n')) >= 0){
      const line = buf.slice(0, idx).trim();
      buf = buf.slice(idx+1);
      if (!line) continue;
      try{ onLine(JSON.parse(line)); }catch{/* ignore */ }
    }
  }
}

async function onSearchTextStream(){
  const q = $s('#txtQuery').value.trim(); if(!q){ alert('請輸入文字'); return; }
  const topk = +$s('#rangeTopK').value; const index_dir = undefined;
  clearResults();
  let seen = 0; const t0 = performance.now();
  setSearchStatus('以文搜圖中（串流）…');
  await streamNDJSON(ENDPOINTS.search_text_stream, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ text: q, topk, index_dir })
  }, (msg)=>{
    if (msg.type === 'item'){ appendResultItem(msg); seen++; setSearchStatus(`已收到 ${seen} 筆…`); }
    else if (msg.type === 'done'){ setSearchStatus(`完成：共 ${seen} 筆（${fmtMs(performance.now()-t0)}）`); }
    else if (msg.type === 'error'){ setSearchStatus('查詢失敗'); alert('查詢失敗：'+msg.detail); }
  });
}

async function onSearchImageStream(){
  const f = $s('#fileSearchImg').files?.[0];
  if(!f){ alert('請選擇圖片'); return; }

  const fd = new FormData();
  fd.append('file', f);
  fd.append('topk', $s('#rangeTopK').value);

  const idx = getVal('#idxDir');
  if (idx) fd.append('index_dir', idx);

  clearResults();
  let seen = 0; const t0 = performance.now();
  setSearchStatus('以圖搜圖中（串流）…');

  try{
    await streamNDJSON(ENDPOINTS.search_image_stream, { method:'POST', body: fd }, (msg)=>{
      if (msg.type === 'item'){ appendResultItem(msg); seen++; setSearchStatus(`已收到 ${seen} 筆…`); }
      else if (msg.type === 'done'){ setSearchStatus(`完成：共 ${seen} 筆（${fmtMs(performance.now()-t0)}）`); }
      else if (msg.type === 'error'){ setSearchStatus('查詢失敗'); alert('查詢失敗：'+msg.detail); }
    });
  }catch(err){
    console.error(err);
    setSearchStatus('查詢失敗');
    alert('查詢失敗：' + (err?.message || err));
  }
}

async function onSearchC2DFStream(){
  const f = $s('#fileSearchC2').files?.[0];
  if(!f){ alert('請選擇 .c2df 檔'); return; }

  const fd = new FormData();
  fd.append('file', f);
  fd.append('topk', $s('#rangeTopK').value);

  const idx = getVal('#idxDir');
  if (idx) fd.append('index_dir', idx);

  clearResults();
  let seen = 0; const t0 = performance.now();
  setSearchStatus('.c2df 搜圖中（串流）…');

  try{
    await streamNDJSON(ENDPOINTS.search_c2df_stream, { method:'POST', body: fd }, (msg)=>{
      if (msg.type === 'item'){ appendResultItem(msg); seen++; setSearchStatus(`已收到 ${seen} 筆…`); }
      else if (msg.type === 'done'){ setSearchStatus(`完成：共 ${seen} 筆（${fmtMs(performance.now()-t0)}）`); }
      else if (msg.type === 'error'){ setSearchStatus('查詢失敗'); alert('查詢失敗：'+msg.detail); }
    });
  }catch(err){
    console.error(err);
    setSearchStatus('查詢失敗');
    alert('查詢失敗：' + (err?.message || err));
  }
}

document.getElementById('btnSearchText').addEventListener('click', onSearchTextStream);
document.getElementById('btnSearchImage').addEventListener('click', onSearchImageStream);
document.getElementById('btnSearchC2DF').addEventListener('click', onSearchC2DFStream);
</script>


</body>
</html>